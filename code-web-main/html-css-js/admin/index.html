<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Pizza Admin</title>
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
</head>

<body>

    <div class="container">
        <aside id="sidebar">
            <a class="sidebar-link active" onclick="switchTab('food')">
                <i class="lni lni-dinner"></i> Món ăn
            </a>
            <a class="sidebar-link" onclick="switchTab('category')">
                <i class="lni lni-layers"></i> Danh mục
            </a>
            <button class="logout">đăng xuất</button>
        </aside>

        <div class="main">

            <div id="tab-food" class="section active">
                <h2>Quản lý món ăn</h2>
                <form class="search" id="searchform">
                    <button type="button" class="btn-open" onclick="openModal('modal-dish')">Thêm món mới</button>
                    <input type="search" id="search" name="search" placeholder="tìm kiếm" value="">
                    <input type="submit" id="timkiem" name="timkiem" value="Tìm">
                </form>

                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên món</th>
                            <th>Danh mục</th>
                            <th>Giá</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="food-table-body">
                    </tbody>
                </table>
                <div id="paginate-container"></div>
            </div>

            <div id="tab-category" class="section">
                <h2>Quản lý danh mục</h2>
                <form class="search" id="searchform">
                    <button type="button" class="btn-open" onclick="openModal('modal-category')">Thêm danh mục</button>
                    <input type="search" id="search" name="search" placeholder="tìm kiếm">
                    <input type="submit" id="timkiem" name="timkiem" value="Tìm">
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên danh mục</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="category-table-body">
                    </tbody>
                </table>
                <div id="paginate-container"></div>
            </div>

        </div>
    </div>

    <div class="modal" id="modal-dish">
        <div class="modal-box">
            <h3 id="modal-dish-title">Thêm món ăn</h3>
            <input type="hidden" id="dish-id">
            <input type="text" id="dish-name" placeholder="Tên món ăn">
            <select id="dish-category">
                <option value="">Chọn danh mục</option>
            </select>
            <input type="number" id="dish-price" placeholder="Giá tiền">
            <button class="btn-submit" onclick="saveDish()">Lưu</button>
            <button class="btn-close" onclick="closeModal('modal-dish')">Đóng</button>
        </div>
    </div>

    <div class="modal" id="modal-category">
        <div class="modal-box">
            <h3 id="modal-category-title">Thêm danh mục</h3>
            <input type="hidden" id="cat-id">
            <input type="text" id="cat-name" placeholder="Tên danh mục">
            <button class="btn-submit" onclick="saveCategory()">Lưu</button>
            <button class="btn-close" onclick="closeModal('modal-category')">Đóng</button>
        </div>
    </div>

    <script>
        //number of item per page
        const pageSize = 10;
        
        const selection = [
            { id: 1, name: 'food', activeTab: true, currentPage: 1 },
            { id: 2, name: 'category', activeTab: false, currentPage: 1 }
        ];

        let foods, categories, searchterm, foodsearch, catesearch;

        document.addEventListener("DOMContentLoaded", () => {
            const tabfood = document.getElementById("tab-food");
            const tabcate = document.getElementById("tab-category");

            const foodform = tabfood.querySelector("#searchform");
            const cateform = tabcate.querySelector("#searchform");

            foodsearch = foodform.querySelector("#search");
            catesearch = cateform.querySelector("#search");

            if (foodform) {
                foodform.addEventListener('submit', (event) => {
                    event.preventDefault();
                    searchterm = foodsearch.value;
                    loadMenu();
                })
            }
            else {
                console.log("nothing found")
            }
            if (cateform) {
                cateform.addEventListener('submit', (event) => {
                    event.preventDefault();
                    searchterm = catesearch.value;
                    loadMenu();
                })
            }
            else {
                console.log("nothing found")
            }
        })

        //sql function
        async function sql(crud, type, params) {
            try {
                switch (crud) {
                    case 'edit':
                        await fetch("/api/admin/edit", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ type, params })
                        })
                        break;
                    case 'insert':
                        await fetch("/api/admin/insert", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ type, params })
                        })
                        break;
                    case 'delete':
                        await fetch("/api/admin/delete", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ type, params })
                        })
                        break;
                    case 'search':
                        const res = await fetch("/api/admin/search", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ type, params })
                        })
                        return res;
                }
            }
            catch (err) {
                console.error("something went wrong!", err.message);
            }
        }

        //search function
        async function search(type, term) {
            try {
                const sqlresult = await sql('search', type, { data: term });

                if (sqlresult.ok) {
                    const danhmuc = await sqlresult.json();
                    return danhmuc;
                }
                else {
                    const msg = await sqlresult.json();
                    alert(msg.error);
                }


            }
            catch (err) {
                console.error("loading page failed", err.message);
            }
        }


        //create array of data with page data limitation
        function paginate(data, currentpage, pagesize) {
            if (!Array.isArray(data) || data.length == 0) {
                return [];
            }

            const safePageSize = Math.max(1, pageSize);
            const safeCurrentPage = Math.max(1, currentpage);

            const startIndex = (safeCurrentPage - 1) * safePageSize;

            const endIndex = startIndex + safePageSize;

            return data.slice(startIndex, endIndex);
        }

        //get total page
        function getTotalPages(data, pageSize) {
            if (!Array.isArray(data) || data.length === 0 || pageSize <= 0) {
                return 0;
            }

            return Math.ceil(data.length / pageSize);
        }

        //Create page selector
        function renderPaginationControls(currentPage, totalPages) {
            const tab = document.getElementsByClassName("section active")[0];
            const container = tab.querySelector("#paginate-container");

            if (!container) {
                console.log("error");
                return;
            }

            container.innerHTML = '';

            if (totalPages === 1) {
                return;
            }

            let htmlpage = '';

            const prevcheck = currentPage === 1 ? 'disabled' : '';
            htmlpage += `<button
                        class = "paginate-prev ${prevcheck}"
                        onclick ="renderPage(${currentPage - 1})"
                        ${prevcheck}>
                        Previous
                        </button>`

            for (let i = 1; i <= totalPages; i++) {
                const activepage = i === currentPage ? 'disabled' : '';

                htmlpage += `<button
                            class ="paginate-number ${activepage}"
                            onclick ="renderPage(${i})"
                            ${activepage}>
                            ${i}
                            </button>`
            }

            const nextcheck = currentPage === totalPages ? 'disabled' : '';
            htmlpage += `<button
                        class = "paginate-next ${nextcheck}"
                        onclick ="renderPage(${currentPage + 1})"
                        ${nextcheck}>
                        Next
                        </button>`

            container.innerHTML = htmlpage;
        }



        //create an index page with number 
        function renderPage(pageNumber) {
            const activesel = selection.find(s => s.activeTab == true);
            activesel.currentPage = pageNumber;
            let allItems;

            switch (activesel.name) {
                case "food":
                    allItems = foods;
                    break;
                case "category":
                    allItems = categories;
                    break;
            }

            // 1. Get the data for the new page
            const itemsToShow = paginate(allItems, activesel.currentPage, pageSize);

            // 2. Get the navigation data
            const totalPages = getTotalPages(allItems, pageSize);

            if (activesel.name == "food") {
                renderFoods(itemsToShow);
            }
            else {
                renderCategories(itemsToShow);
            }
            renderPaginationControls(activesel.currentPage, totalPages);
        }

        //reload data
        async function loadMenu() {
            const activesel = selection.find(s => s.activeTab == true);
            const sortproduct = await fetch("/api/admin/getmenu", {
                method: "POST",
                header: { "Content-Type": "application/json" }
            });

            const categoryprod = await fetch("/api/admin/getcate", {
                method: "POST",
                header: { "Content-Type": "application/json" }
            })

            food = '';
            categories = '';

            
            foods = await sortproduct.json();
            categories = await categoryprod.json();
            let tempstorage = [];

            if(searchterm){
                if(activesel.name == 'food'){
                    foods = await search(activesel.name, searchterm);
                    activesel.currentPage = 1;
                }
                else if(activesel.name == 'category'){
                    categories = await search(activesel.name, searchterm);
                    activesel.currentPage = 1;
                }
            }

            Object.keys(foods).forEach(name => {
                const fooddetail = foods[name];
                fooddetail.forEach(food => {
                    tempstorage.push(food);
                }
                )
            });
            foods = tempstorage;


            foods.forEach((food,indexnum) =>{
                food.index = indexnum + 1;
            });
            categories.forEach((category,indexnum) =>{
                category.index = indexnum + 1;
            });

            // console.log(categories);
            // console.log(foods);

            const itemsToShow = paginate(foods, selection.find(s => s.name == 'food').currentPage, pageSize);
            const itemsToShow1 = paginate(categories, selection.find(s => s.name == 'category').currentPage, pageSize);

            renderCategories(itemsToShow1);
            renderFoods(itemsToShow);
            renderPage(activesel.currentPage);

        }
        loadMenu();


        function openModal(modalId) {
            // Reset form khi mở mới
            if (modalId === 'modal-dish') {
                document.getElementById('dish-id').value = '';
                document.getElementById('dish-name').value = '';
                document.getElementById('dish-price').value = '';
                document.getElementById('dish-category').value = '';
                document.getElementById('modal-dish-title').innerText = "Thêm món ăn";
                renderDishCategoryOptions();
            } else {
                document.getElementById('cat-id').value = '';
                document.getElementById('cat-name').value = '';
                document.getElementById('modal-category-title').innerText = "Thêm danh mục";
            }
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Danh mục

        function renderCategories(arrcategories) {
            const tbody = document.getElementById('category-table-body');
            tbody.innerHTML = '';

            arrcategories.forEach(cat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cat.index}</td>
                    <td>${cat.CateName}</td>
                    <td>
                        <button class="btn-edit" onclick="editCategory(${cat.IDCate})">Sửa</button>
                        <button class="btn-delete" onclick="deleteCategory(${cat.IDCate})">Xóa</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function saveCategory() {
            try {
                const id = document.getElementById('cat-id').value;
                const name = document.getElementById('cat-name').value;

                if (!name) return alert("Vui lòng nhập tên danh mục");

                if (id) {
                    // Sửa (Update)
                    // const index = categories.findIndex(c => c.IDCate == id);
                    // categories[index].CateName = name;
                    await sql('edit', 'category', { id: id, name: name });

                } else {
                    // Thêm mới (Create)
                    // const newId = categories.length > 0 ? categories[categories.length - 1].IDCate + 1 : 1;
                    // categories.push({ IDCate: newId, CateName: name });
                    await sql('insert', 'category', { name: name });

                }
                await loadMenu();

                const activesel = selection.find(s => s.activeTab == true);
                const activese2 = selection.find(s => s.activeTab == false);
                const itemsToShow = paginate(foods, activese2.currentPage, pageSize);
                const itemsToShow1 = paginate(categories, activesel.currentPage, pageSize);

                closeModal('modal-category');
                renderCategories(itemsToShow1);
                renderFoods(itemsToShow); // Render lại món ăn vì tên danh mục có thể đổi
            }
            catch (err) {
                console.error("err", err.message);
                await loadMenu();
            }
        }

        function editCategory(id) {
            const cat = categories.find(c => c.IDCate === id);
            document.getElementById('cat-id').value = cat.IDCate;
            document.getElementById('cat-name').value = cat.CateName;
            document.getElementById('modal-category-title').innerText = "Sửa danh mục";
            document.getElementById('modal-category').classList.add('show');
        }



        async function deleteCategory(id) {
            if (confirm("Bạn có chắc muốn xóa?")) {
                // categories = categories.filter(c => c.IDCate !== id);
                // Xóa luôn các món thuộc danh mục này (Tùy chọn)
                try {
                    // foods = foods.filter(f => f.TypeProd !== id);
                    renderPage(1);
                    await sql('delete', 'category', { id: id });
                    await loadMenu();
                }
                catch (err) {
                    console.error("err", err.message);
                    await loadMenu()
                }
                finally {
                    const activesel = selection.find(s => s.activeTab == true);
                    const activese2 = selection.find(s => s.activeTab == false);
                    const itemsToShow = paginate(foods, activese2.currentPage, pageSize);
                    const itemsToShow1 = paginate(categories, activesel.currentPage, pageSize);

                    renderCategories(itemsToShow1);
                    renderFoods(itemsToShow);
                }
            }
        }

        // Chuyển tab
        async function switchTab(tabName) {
            // Ẩn hết các section
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            let foodsel = selection.find(f => f.name == "food");
            let catesel = selection.find(f => f.name == "category");
            searchterm = '';
            catesearch.value ='';
            foodsearch.value='';
            // Hiện tab được chọn
            try{
            if (tabName === 'food') {
                foodsel.activeTab = true;
                catesel.activeTab = false;
                // console.log(catesel);
                // console.log(foodsel);
                document.getElementById('tab-food').classList.add('active');
                document.querySelector('.sidebar-link:nth-child(1)').classList.add('active');
                await renderPage(1);
                await loadMenu();
                await renderDishCategoryOptions(); // Cập nhật dropdown danh mục
            } else {
                catesel.activeTab = true;
                foodsel.activeTab = false;
                // console.log(catesel);
                // console.log(foodsel);
                document.getElementById('tab-category').classList.add('active');
                document.querySelector('.sidebar-link:nth-child(2)').classList.add('active');
                await renderPage(1);
                await loadMenu();
            }
        }
        catch(err){
            console.error("error in switch");
        }
        }
        // let categories = [
        //     { id: 1, name: 'Pizza' },
        //     { id: 2, name: 'Gà rán' }
        // ];

        // let foods = [
        //     { id: 1, name: 'ok chưa', categoryId: 1, price: 150000 },
        //     { id: 2, name: 'ok rồi', categoryId: 2, price: 20000 }
        // ];

        // HÀM CHUNG

        // Khởi chạy lúc đầu






        // Món ăn:

        // Hàm hỗ trợ: Lấy tên danh mục từ ID
        function getCategoryName(catId) {
            const cat = categories.find(c => c.IDCate == catId); //DATABASE
            return cat ? cat.CateName : 'Chưa phân loại';
        }

        // Hàm hỗ trợ: Đổ danh mục vào thẻ Select trong Modal Món ăn
        function renderDishCategoryOptions() {
            const select = document.getElementById('dish-category');
            select.innerHTML = '<option value="">Chọn danh mục</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.IDCate;
                option.innerText = cat.CateName;
                select.appendChild(option);
            });
        }

        function renderFoods(foods) {
            const tbody = document.getElementById('food-table-body');
            tbody.innerHTML = '';

            foods.forEach(food => {

                const tr = document.createElement('tr'); //DATABASE
                tr.innerHTML = `
                    <td>${food.index}</td> 
                    <td>${food.NameProd}</td> 
                    <td>${getCategoryName(food.TypeProd)}</td> 
                    <td>${food.Price} đ</td> 
                    <td>
                        <button class="btn-edit" onclick="editFood(${food.IDProd})">Sửa</button> 
                        <button class="btn-delete" onclick="deleteFood(${food.IDProd})">Xóa</button> 
                    </td>
                `;
                tbody.appendChild(tr);
            });

        }

        async function saveDish() {
            try {

                const id = document.getElementById('dish-id').value;
                const name = document.getElementById('dish-name').value;
                const catId = document.getElementById('dish-category').value;
                const price = document.getElementById('dish-price').value;

                if (!name || !catId || !price) return alert("Vui lòng nhập đủ thông tin");

                if (id) {
                    // Sửa
                    // const index = foods.findIndex(f => f.IDProd == id);
                    // foods[index] = { IDProd: parseInt(id), NameProd: name, TypeProd: parseInt(catId), Price: parseInt(price) };
                    await sql('edit', 'food', { id: parseInt(id), name: name, type: parseInt(catId), price: parseInt(price) });
                } else {
                    // Thêm
                    // const newId = foods.length > 0 ? foods[foods.length - 1].IDProd + 1 : 1;
                    // foods.push({ IDProd: newId, NameProd: name, TypeProd: parseInt(catId), Price: parseInt(price) });
                    await sql('insert', 'food', { id: parseInt(id), name: name, type: parseInt(catId), price: parseInt(price) });
                }
                await loadMenu();
            }
            catch (err) {
                console.error("error", err.message);
                loadMenu();
            }
            finally {
                const activesel = selection.find(s => s.activeTab == true);
                const itemsToShow = paginate(foods, activesel.currentPage, pageSize);

                closeModal('modal-dish');
                renderPage(activesel.currentPage);
                renderFoods(itemsToShow);
            }
        }

        function editFood(id) {
            const food = foods.find(f => f.IDProd == id); //database
            document.getElementById('dish-id').value = food.IDProd;
            document.getElementById('dish-name').value = food.NameProd;
            document.getElementById('dish-price').value = food.Price;
            renderDishCategoryOptions();
            document.getElementById('dish-category').value = food.TypeProd;

            document.getElementById('modal-dish-title').innerText = "Sửa món ăn";
            document.getElementById('modal-dish').classList.add('show');
        }

        async function deleteFood(id) {
            if (confirm("Xóa món ăn này?")) {
                // foods = foods.filter(f => f.IDProd !== id);
                try {
                    renderPage(1);
                    // console.log(id);
                    await sql('delete', 'food', { id: parseInt(id) });
                    await loadMenu();
                }
                catch (err) {
                    console.error("Deletion failed:", error);

                    // Revert foods array if the deletion failed
                    // foods = foods.filter(f => f.IDProd === id).concat(foods); 
                    // Then reload the menu to get the original data back
                    await loadMenu();
                }
                finally {
                    const activesel = selection.find(s => s.activeTab == true);
                    const itemsToShow = paginate(foods, activesel.currentPage, pageSize);
                    renderFoods(itemsToShow);
                }
            }
        }

    </script>
</body>

</html>